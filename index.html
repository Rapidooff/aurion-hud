<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- iOS/PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0f18">
  <!-- Minimal inline icons -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs/%3E%3Crect width='64' height='64' rx='14' ry='14' fill='%230b1224'/%3E%3Ctext x='32' y='41' text-anchor='middle' font-family='Arial' font-size='36' font-weight='700' fill='%2338c7ff'%3EA%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAAB3X2wPAAAAFklEQVR4Ae3BAQ0AAADCoPdPbQ43oAAAAAAAAJ0Hq1wAAa+0y0YAAAAASUVORK5CYII=">
  <!-- Inline manifest (single-file) -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Aurion HUD","short_name":"Aurion","start_url":"./","display":"standalone","background_color":"#05060a","theme_color":"#0b0f18","icons":[{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAAB3X2wPAAAAFklEQVR4Ae3BAQ0AAADCoPdPbQ43oAAAAAAAAJ0Hq1wAAa+0y0YAAAAASUVORK5CYII=","sizes":"64x64","type":"image/png"}]}'>
  <title>Aurion HUD ‚Äî Studio Rapido</title>
  <style>
    :root{
      --bg:#05060a;
      --panel:#0b0f18;
      --panel-2:#0f1422;
      --txt:#d9f1ff;
      --muted:#91a7bd;
      --accent:#38c7ff;
      --accent-2:#7cffc1;
      --danger:#ff8f8f;
      --ok:#77ff8f;
      --glow: 0 0 16px rgba(56,199,255,.30),0 0 60px rgba(56,199,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% -10%, #0a101e 0%, #05060a 40%, #05060a 100%);
      color:var(--txt);
      font: 500 15px/1.45 ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      letter-spacing:.2px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px 0 20px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:36px;height:36px;border:1px solid #1e2a3d;border-radius:12px;
      background:linear-gradient(160deg,#0e1730,#0b1224);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), var(--glow);
      display:grid;place-items:center;color:var(--accent);font-weight:800;
    }
    .subtitle{opacity:.6;font-size:12px;margin-top:-2px}
    .toolbar{display:flex;gap:10px}
    .btn{
      background:#0b162a;border:1px solid #163054;color:#cfe9ff;
      border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:600
    }
    .btn:hover{filter:brightness(1.15)}
    .grid{
      display:grid;gap:16px;
      grid-template-columns: repeat(12,1fr);
      padding:16px 20px 24px 20px;
    }
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid #142033;
      border-radius:14px;
      padding:16px;
      min-height:120px;
      position:relative;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px 0;font-size:14px;letter-spacing:.8px;text-transform:uppercase;color:#a8c4de}
    .hint{position:absolute;right:14px;top:12px;font-size:11px;opacity:.5}
    .big{font-size:48px;line-height:1;letter-spacing:1.5px;font-weight:800;text-shadow: var(--glow);}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .chip{border:1px solid #1c2a3f;background:#0a1424;border-radius:999px;padding:6px 10px;font-size:12px;color:#b8d3ea}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .list{margin:8px 0 0 0;padding-left:18px}
    .list li{margin:6px 0}
    input[type="text"], input[type="url"]{
      background:#0b162a;border:1px solid #163054;color:#cfe9ff;border-radius:10px;padding:8px 10px;width:100%;
    }
    textarea{background:#0b162a;border:1px solid #163054;color:#cfe9ff;border-radius:10px;padding:10px;width:100%;min-height:120px;resize:vertical}
    .small{font-size:12px;opacity:.8}
    .meter{
      width:100%;height:8px;border-radius:999px;background:#0c1528;border:1px solid #17345a;overflow:hidden
    }
    .meter>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#27b1ff,#7cffc1)}
    .badge{padding:4px 8px;border-radius:8px;border:1px solid #27456e;background:#0b162a;font-size:12px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .footer{
      padding:0 20px 18px 20px;display:flex;justify-content:space-between;align-items:center;
      color:#7fa6c9;font-size:12px;opacity:.85
    }
    @media (max-width: 1000px){ .grid{grid-template-columns: repeat(6,1fr)} }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; gap:20px; padding:12px }
      header{ padding:12px 12px 0 }
      .toolbar{ flex-wrap: wrap }
      .toolbar .btn{ flex:1 }
      .card{ padding:14px; border-radius:12px }
      .card h2{ font-size:13px }
      .big{ font-size:32px }
      .chip{ font-size:11px; padding:5px 8px }
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .kbd{font:600 12px ui-monospace, SFMono-Regular, Menlo, monospace;border:1px solid #27456e;background:#0b162a;border-radius:6px;padding:2px 6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px}
    /* Compact mode (toggle via .compact on <body>) */
    body.compact .grid{gap:12px;padding:12px 12px 18px}
    body.compact header{padding:12px 12px 0}
    body.compact .card{padding:12px;border-radius:12px}
    body.compact .btn{padding:6px 8px}
    body.compact .big{font-size:36px}
    @media (max-width:420px){
      .btn{padding:6px 8px}
      .big{font-size:40px}
      header .subtitle{font-size:11px}
    }
    @media (max-width: 360px){
      .btn{ padding:6px 8px }
      .big{ font-size:28px }
    }
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none!important;animation:none!important}
    }
    body.reduce-motion *{transition:none!important;animation:none!important}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <div style="font-weight:800;letter-spacing:1.2px">AURION ¬∑ HUD</div>
        <div class="subtitle">Cockpit local ‚Äî Studio Rapido</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="fullscreenBtn">Plein √©cran</button>
      <button class="btn" id="saveBtn">Sauver</button>
      <button class="btn" id="installBtn">Installer (offline)</button>
      <button class="btn" id="clearCacheBtn">Reset cache</button>
      <button class="btn" id="settingsBtn">R√©glages</button>
    </div>
  </header>

  <section class="grid">
    <!-- Horloge & r√©seau -->
    <div class="card" style="grid-column: span 4">
      <div class="hint">Temps r√©el</div>
      <h2>Horloge</h2>
      <div class="big" id="clock">--:--</div>
      <div class="muted" id="dateLine">--</div>
      <div class="row" style="margin-top:12px">
        <span class="chip" id="onlineChip">Statut: ...</span>
        <span class="chip" id="latencyChip">Latence: -- ms</span>
      </div>
      <div class="meter" style="margin-top:10px"><i id="latencyBar"></i></div>
      <canvas id="latencyPlot" height="36" style="width:100%;margin-top:8px;border:1px solid #17345a;border-radius:8px;background:#0a1424"></canvas>
    </div>

    <!-- Statut r√©seau + tips -->
    <div class="card" style="grid-column: span 4">
      <div class="hint">Freebox</div>
      <h2>Statut R√©seau</h2>
      <div id="statusLine" class="small">Analyse en cours‚Ä¶</div>
      <ul class="list small" id="netHints"></ul>
      <div class="small muted" style="margin-top:8px">Astuce¬†: renomme les appareils dans DHCP (ex¬†: RAPIDO‚ÄëDEV, EVA_PHONE).</div>
    </div>

    <!-- Raccourcis -->
    <div class="card" style="grid-column: span 4">
      <div class="hint">Acc√®s rapide</div>
      <h2>Raccourcis</h2>
      <ul class="list">
        <li>Admin routeur¬†: <a href="http://mafreebox.freebox.fr" target="_blank" rel="noopener">mafreebox.freebox.fr</a></li>
        <li>Fichiers partag√©s (USB)¬†: activer le partage dans l‚Äôadmin</li>
        <li>Wi‚ÄëFi invit√©¬†: activer/d√©sactiver dans Wi‚ÄëFi invit√©</li>
      </ul>
    </div>

    <!-- M√©t√©o (Open‚ÄëMeteo) -->
    <div class="card" style="grid-column: span 6">
      <div class="hint">Open‚ÄëMeteo (sans cl√©)</div>
      <h2>M√©t√©o</h2>
      <div class="row" style="margin-bottom:8px">
        <input type="text" id="cityInput" placeholder="Ta ville (ex¬†: Paris) ‚Äî ou autorise la g√©olocalisation">
        <button class="btn" id="citySearchBtn">Chercher</button>
        <span id="geoBtn" class="btn">üìç Localiser</span>
      </div>
      <div class="row small">
        <span class="badge" id="cityBadge">Ville¬†: ‚Äî</span>
        <span class="badge" id="coordsBadge">Coords¬†: ‚Äî</span>
        <span class="badge" id="tzBadge">TZ¬†: ‚Äî</span>
      </div>
      <div class="row" style="margin-top:12px;align-items:flex-end">
        <div style="min-width:120px">
          <div class="muted small">Temp√©rature</div>
          <div class="big" id="tempNow">‚Äî¬∞</div>
        </div>
        <div>
          <div class="muted small">Ciel</div>
          <div id="wdesc" class="inline"><span>‚Äî</span></div>
        </div>
        <div>
          <div class="muted small">Vent</div>
          <div id="windNow">‚Äî km/h</div>
        </div>
      </div>
      <div class="small muted" style="margin-top:10px" id="meteoDebug"></div>
    </div>

    <!-- Appareils (manuel + localStorage) -->
    <div class="card" style="grid-column: span 6">
      <div class="hint">Inventaire</div>
      <h2>Appareils</h2>
      <ul class="list" id="deviceList"></ul>
      <div class="row" style="margin-top:10px">
        <input type="text" id="deviceInput" placeholder="Ajouter un appareil (ex¬†: RAPIDO‚ÄëDEV)">
        <button class="btn" id="addDeviceBtn">Ajouter</button>
        <button class="btn" id="clearDeviceBtn">Vider</button>
        <button class="btn" id="devExport">Exporter</button>
        <label class="btn" for="devImportInput">Importer</label>
        <input type="file" id="devImportInput" accept="application/json" style="display:none">
      </div>
    </div>

    <!-- Bloc‚Äënotes -->
    <div class="card" style="grid-column: span 6">
      <div class="hint">localStorage</div>
      <h2>Bloc‚Äënotes</h2>
      <textarea id="notesArea" placeholder="Notes, SSID, todo‚Ä¶"></textarea>
      <div class="small muted" style="margin-top:6px">Sauvegard√© localement ‚Äî rien n‚Äôest envoy√©.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="notesExport">Exporter</button>
        <label class="btn" for="notesImportInput">Importer</label>
        <input type="file" id="notesImportInput" accept="application/json" style="display:none">
      </div>
    </div>

    <!-- Lecteur Audio -->
    <div class="card" style="grid-column: span 6">
      <div class="hint">Audio local</div>
      <h2>Ambiance</h2>
      <div class="row">
        <input type="file" id="audioFile" accept="audio/*">
        <button class="btn" id="playBtn">Lecture/Pause</button>
        <span id="audioName" class="small muted">Aucun fichier</span>
      </div>
      <audio id="player" preload="metadata"></audio>
    </div>

    <!-- Console Aurion (branchable) -->
    <div class="card" style="grid-column: span 12">
      <div class="hint">HTTP POST</div>
      <h2>Console Aurion</h2>
      <div class="row small" id="aurionHealthRow" style="margin-top:-6px">
        <span class="badge" id="aurionHealth">Sant√©¬†: inconnue</span>
        <a href="#" id="aurionHelp">Aide</a>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input type="url" id="aurionUrl" placeholder="Endpoint Aurion (ex¬†: http://localhost:3000/aurion)">
        <input type="text" id="aurionKey" placeholder="Cl√©/API (optionnel)">
        <button class="btn" id="aurionSave">Enregistrer</button>
        <button class="btn" id="aurionTest">Tester</button>
      </div>
      <div class="row">
        <input type="text" id="aurionPrompt" placeholder="Tape une commande (ex¬†: 'Donne l‚Äô√©tat du r√©seau en 1 ligne')">
        <button class="btn" id="aurionSend">Envoyer</button>
      </div>
      <pre id="aurionOut" class="mono" style="margin-top:12px;white-space:pre-wrap;word-break:break-word;background:#0a1424;border:1px solid #17345a;border-radius:10px;padding:12px;max-height:260px;overflow:auto">Aucune sortie pour l‚Äôinstant.</pre>
      <div class="row small" style="margin-top:8px">
        <button class="btn" id="outCopy">Copier</button>
        <button class="btn" id="outClear">Effacer</button>
      </div>
      <div class="small muted">Cette console fait un <span class="kbd">fetch POST</span> r√©el. Si l‚ÄôURL n‚Äôest pas d√©finie, l‚Äôenvoi est refus√© (pas de simulation).</div>
    </div>
  </section>

  <div class="footer">
    <div>¬© Studio Rapido ‚Äî Aurion</div>
    <div class="small">Astuce¬†: ajoute cette page √† l‚Äô√©cran d‚Äôaccueil de ton t√©l√©phone (PWA‚Äëlite) et passe en plein √©cran.</div>
  </div>

  <script>
    // ---------------- Clock & date ----------------
    function pad(n){return String(n).padStart(2,'0')}
    function updateClock(){
      const d = new Date();
      document.getElementById('clock').textContent = pad(d.getHours())+':'+pad(d.getMinutes());
      const days = ["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."];
      const months = ["janv.","f√©vr.","mars","avr.","mai","juin","juil.","ao√ªt","sept.","oct.","nov.","d√©c."];
      document.getElementById('dateLine').textContent = days[d.getDay()]+" "+d.getDate()+" "+months[d.getMonth()]+" "+d.getFullYear();
    }
    updateClock();
    setInterval(updateClock,60*1000);
    // ---------------- PWA-lite: inline Service Worker for offline ----------------
    (function(){
      if('serviceWorker' in navigator){
        const swCode = `const V='aurion-hud-v2';self.addEventListener('install',e=>{e.waitUntil(caches.open(V).then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k.startsWith('aurion-hud-')&&k!==V).map(k=>caches.delete(k)))))});self.addEventListener('fetch',e=>{const req=e.request;if(req.method!=='GET'){return e.respondWith(fetch(req).catch(()=>new Response('offline',{status:503})))};const url=new URL(req.url);if(e.request.mode==='navigate'){return e.respondWith(fetch(req).catch(()=>caches.match('./')))};e.respondWith(caches.match(req).then(cached=>{const fetchP=fetch(req).then(res=>{if(res&&res.ok){const clone=res.clone();caches.open(V).then(c=>c.put(req,clone))}return res}).catch(()=>cached||fetch(req));return cached||fetchP}))});`;
        const blob = new Blob([swCode], {type:'text/javascript'});
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    })();
    // Reset cache button
    const clearCacheBtn = document.getElementById('clearCacheBtn');
    if(clearCacheBtn){
      clearCacheBtn.onclick = async ()=>{
        try{
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k.startsWith('aurion-hud-')).map(k=>caches.delete(k)));
          if('serviceWorker' in navigator){
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r=>r.unregister()));
          }
          alert('Cache et Service Worker r√©initialis√©s. Recharge la page.');
        }catch(e){ alert('Reset cache: '+e.message); }
      };
    }
    const installBtn = document.getElementById('installBtn');
    if(installBtn){
      // iOS n'a pas d'√©v√©nement beforeinstallprompt ‚Äî on affiche juste une aide
      installBtn.onclick = ()=>{
        alert("iPhone/iPad : Ouvre dans Safari ‚Üí Partager ‚Üí Ajouter √† l‚Äô√©cran d‚Äôaccueil.\nAndroid/Chrome : menu ‚ãÆ ‚Üí Installer l‚Äôapplication.");
      };
    }

    // ---------------- Online & latency ----------------
    const onlineChip = document.getElementById('onlineChip');
    const latencyChip = document.getElementById('latencyChip');
    const latencyBar  = document.getElementById('latencyBar');

    function setOnlineStatus(){
      const online = navigator.onLine;
      onlineChip.textContent = online ? "Statut¬†: en ligne" : "Statut¬†: hors ligne";
      onlineChip.style.borderColor = online ? "#1f6b3a" : "#6b1f1f";
      onlineChip.style.color = online ? "#9affb0" : "#ff9a9a";
    }
    setOnlineStatus();
    addEventListener('online', setOnlineStatus);
    addEventListener('offline', setOnlineStatus);

    async function latencyTest(){
      const start = performance.now();
      try{
        // Two targets to improve reliability (no-cors):
        const targets = ["https://1.1.1.1/cdn-cgi/trace","https://www.google.com/generate_204"];
        const url = targets[Math.floor(Math.random()*targets.length)] + "?ts="+Date.now();
        await fetch(url, {mode:"no-cors", cache:"no-store"});
        const ms = Math.round(performance.now() - start);
        latencyChip.textContent = "Latence¬†: "+ms+" ms";
        const pct = Math.max(3, Math.min(100, 100 - Math.min(500, ms)/5*1)); // crude map
        latencyBar.style.width = pct+"%";
      }catch(e){
        latencyChip.textContent = "Latence¬†: n/d";
        latencyBar.style.width = "0%";
      }
    }
    latencyTest();
    setInterval(latencyTest, 15000);
    // Latency sparkline
    const latHist = [];
    const plot = document.getElementById('latencyPlot');
    function drawLatency(){
      if(!plot) return; const w = plot.clientWidth; const h = plot.height; plot.width = w; const ctx = plot.getContext('2d');
      ctx.clearRect(0,0,w,h); if(latHist.length<2) return;
      const max = Math.max(...latHist, 300); const min = 0;
      ctx.beginPath(); ctx.moveTo(0, h - (latHist[0]-min)/(max-min)*h);
      for(let i=1;i<latHist.length;i++){
        const x = i*(w/Math.max(1,latHist.length-1));
        const y = h - (latHist[i]-min)/(max-min)*h; ctx.lineTo(x,y);
      }
      ctx.strokeStyle = '#38c7ff'; ctx.lineWidth = 2; ctx.stroke();
    }
    const _origLatencyTest = latencyTest;
    async function latencyTest(){
      const start = performance.now();
      try{
        const targets = ["https://1.1.1.1/cdn-cgi/trace","https://www.google.com/generate_204"]; const url = targets[Math.floor(Math.random()*targets.length)] + "?ts="+Date.now();
        await fetch(url, {mode:"no-cors", cache:"no-store"});
        const ms = Math.round(performance.now() - start);
        latencyChip.textContent = "Latence¬†: "+ms+" ms";
        const pct = Math.max(3, Math.min(100, 100 - Math.min(500, ms)/5*1));
        latencyBar.style.width = pct+"%";
        latHist.push(ms); if(latHist.length>60) latHist.shift(); drawLatency();
      }catch(e){
        latencyChip.textContent = "Latence¬†: n/d"; latencyBar.style.width = "0%"; latHist.push(500); if(latHist.length>60) latHist.shift(); drawLatency();
      }
    }
    // redraw on resize
    addEventListener('resize', drawLatency);

    // ---------------- Tips text ----------------
    const statusLine = document.getElementById('statusLine');
    const netHints = document.getElementById('netHints');
    function refreshHints(){
      const hints = [
        "‚Ä¢ Change le SSID et le mot de passe dans l‚Äôadmin Freebox.",
        "‚Ä¢ Active le Wi‚ÄëFi invit√© pour tes amis.",
        "‚Ä¢ Renomme tes appareils dans DHCP (ex¬†: RAPIDO‚ÄëDEV, EVA_PHONE).",
        "‚Ä¢ (Optionnel) Branche une cl√© USB et active le partage."
      ];
      netHints.innerHTML = hints.map(h=>"<li>"+h+"</li>").join("");
      statusLine.innerHTML = navigator.onLine
        ? 'Bo√Ætier¬†: <span class="ok">en ligne (navigateur)</span> ‚Äî configure les options dans la Freebox.'
        : 'Bo√Ætier¬†: <span class="bad">hors ligne (navigateur)</span> ‚Äî v√©rifie le Wi‚ÄëFi/ethernet.';
    }
    refreshHints();

    // ---------------- Devices (localStorage) ----------------
    const LS_DEV = "aurion_devices";
    const deviceList = document.getElementById('deviceList');
    const deviceInput = document.getElementById('deviceInput');
    document.getElementById('addDeviceBtn').onclick = () => {
      const v = deviceInput.value.trim();
      if(!v) return;
      const arr = JSON.parse(localStorage.getItem(LS_DEV) || "[]");
      arr.push(v); localStorage.setItem(LS_DEV, JSON.stringify(arr));
      deviceInput.value = ""; renderDevices();
    };
    document.getElementById('clearDeviceBtn').onclick = () => {
      localStorage.removeItem(LS_DEV); renderDevices();
    };
    deviceInput.addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('addDeviceBtn').click() });
    function renderDevices(){
      const arr = JSON.parse(localStorage.getItem(LS_DEV) || "[]");
      if(!arr.length){ deviceList.innerHTML = "<li class='muted'>Aucun pour l‚Äôinstant.</li>"; return; }
      deviceList.innerHTML = arr.map((d,i)=>`<li class="inline">${d}
        <button class="btn" style="margin-left:6px;padding:4px 8px" onclick="(function(){const a=JSON.parse(localStorage.getItem('${LS_DEV}')||'[]');a.splice(${i},1);localStorage.setItem('${LS_DEV}',JSON.stringify(a));renderDevices();})()">Supprimer</button>
      </li>`).join("");
    }
    renderDevices();
    // Devices export/import
    const devExport = document.getElementById('devExport');
    const devImportInput = document.getElementById('devImportInput');
    if(devExport){
      devExport.onclick = ()=>{
        const arr = JSON.parse(localStorage.getItem(LS_DEV) || '[]');
        const blob = new Blob([JSON.stringify({devices:arr}, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'aurion-devices.json'; a.click();
      };
    }
    if(devImportInput){
      devImportInput.onchange = ()=>{
        const f = devImportInput.files && devImportInput.files[0];
        if(!f) return; const rd = new FileReader();
        rd.onload = ()=>{ try{ const j = JSON.parse(rd.result); if(Array.isArray(j.devices)){ localStorage.setItem(LS_DEV, JSON.stringify(j.devices)); renderDevices(); } else alert('Format invalide'); } catch(e){ alert('Import invalide'); } };
        rd.readAsText(f);
      };
    }

    // ---------------- Notes (localStorage) ----------------
    const LS_NOTES = "aurion_notes_text";
    const notesArea = document.getElementById('notesArea');
    function loadNotes(){ notesArea.value = localStorage.getItem(LS_NOTES) || "" }
    function saveNotes(){ localStorage.setItem(LS_NOTES, notesArea.value); flashBtn(saveBtn); }
    const saveBtn = document.getElementById('saveBtn');
    notesArea.addEventListener('input', ()=>{ /* autosave lite */ setTimeout(saveNotes, 300); });
    function flashBtn(btn){ const t=btn.textContent; btn.textContent="Sauv√© ‚úì"; setTimeout(()=>btn.textContent=t,900) }
    loadNotes();
    // Notes export/import
    const notesExport = document.getElementById('notesExport');
    const notesImportInput = document.getElementById('notesImportInput');
    if(notesExport){
      notesExport.onclick = ()=>{
        const data = { notes: notesArea.value };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'aurion-notes.json';
        a.click();
      };
    }
    if(notesImportInput){
      notesImportInput.onchange = ()=>{
        const f = notesImportInput.files && notesImportInput.files[0];
        if(!f) return;
        const rd = new FileReader();
        rd.onload = ()=>{
          try{ const j = JSON.parse(rd.result); notesArea.value = j.notes || ""; saveNotes(); }
          catch(e){ alert('Import invalide'); }
        };
        rd.readAsText(f);
      };
    }

    // ---------------- Fullscreen ----------------
    document.getElementById('fullscreenBtn').onclick = () => {
      const el = document.documentElement;
      if(!document.fullscreenElement){ el.requestFullscreen?.() } else { document.exitFullscreen?.() }
    };

    // Console actions: copy / clear
    const outCopy = document.getElementById('outCopy');
    const outClear = document.getElementById('outClear');
    if(outCopy){ outCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(aurionOut.textContent||''); flashBtn(outCopy); }catch(e){ alert('Impossible de copier'); } }; }
    if(outClear){ outClear.onclick = ()=>{ aurionOut.textContent = 'Aucune sortie pour l‚Äôinstant.'; }; }

    // Keyboard shortcuts
    addEventListener('keydown', (e)=>{
      if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); aurionPrompt.focus(); aurionPrompt.select(); }
      if((e.metaKey||e.ctrlKey) && e.key==='Enter'){ e.preventDefault(); aurionSend.click(); }
      if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='l'){ e.preventDefault(); if(outClear) outClear.click(); }
    });

    // Settings modal + persistence
    const LS_SETTINGS = 'aurion_settings_v1';
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const settingsClose = document.getElementById('settingsClose');
    const optCompact = document.getElementById('optCompact');
    const optReduceMotion = document.getElementById('optReduceMotion');
    const optClock12h = document.getElementById('optClock12h');
    function loadSettings(){
      try{ const j = JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}');
        document.body.classList.toggle('compact', !!j.compact);
        document.body.classList.toggle('reduce-motion', !!j.reduceMotion);
        optCompact.checked = !!j.compact; optReduceMotion.checked = !!j.reduceMotion; optClock12h.checked = !!j.clock12h;
        window.__aurionClock12h = !!j.clock12h;
      }catch(_){ }
    }
    function saveSettings(){
      const j = { compact: !!optCompact.checked, reduceMotion: !!optReduceMotion.checked, clock12h: !!optClock12h.checked };
      localStorage.setItem(LS_SETTINGS, JSON.stringify(j));
      document.body.classList.toggle('compact', j.compact);
      document.body.classList.toggle('reduce-motion', j.reduceMotion);
      window.__aurionClock12h = !!j.clock12h;
    }
    if(settingsBtn){ settingsBtn.onclick = ()=>{ settingsModal.style.display='flex'; loadSettings(); }; }
    if(settingsClose){ settingsClose.onclick = ()=>{ settingsModal.style.display='none'; saveSettings(); }; }
    // Export/import full config (devices, notes, city, console cfg, settings)
    const cfgExport = document.getElementById('cfgExport');
    const cfgImportInput = document.getElementById('cfgImportInput');
    if(cfgExport){ cfgExport.onclick = ()=>{
      const data = {
        devices: JSON.parse(localStorage.getItem('aurion_devices')||'[]'),
        notes: localStorage.getItem('aurion_notes_text')||'',
        city: JSON.parse(localStorage.getItem('aurion_city')||'null'),
        console: JSON.parse(localStorage.getItem('aurion_console_cfg')||'{}'),
        settings: JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}')
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'aurion-config.json'; a.click();
    }; }
    if(cfgImportInput){ cfgImportInput.onchange = ()=>{
      const f = cfgImportInput.files && cfgImportInput.files[0]; if(!f) return; const rd = new FileReader();
      rd.onload = ()=>{ try{ const j = JSON.parse(rd.result);
        if(j.devices) localStorage.setItem('aurion_devices', JSON.stringify(j.devices));
        if('notes' in j) localStorage.setItem('aurion_notes_text', j.notes||'');
        if(j.city) localStorage.setItem('aurion_city', JSON.stringify(j.city));
        if(j.console) localStorage.setItem('aurion_console_cfg', JSON.stringify(j.console));
        if(j.settings) localStorage.setItem(LS_SETTINGS, JSON.stringify(j.settings));
        renderDevices(); loadNotes(); loadAurionCfg(); loadSettings(); alert('Config import√©e');
      }catch(e){ alert('Config invalide'); } };
      rd.readAsText(f);
    }; }
    // Apply settings on load
    loadSettings();

    // 12h/24h clock support
    (function(){
      const origUpdate = updateClock;
      function updateClock12(){
        const d = new Date();
        let h = d.getHours(); let ampm = '';
        if(window.__aurionClock12h){ ampm = h>=12?' PM':' AM'; h = h%12; if(h===0) h = 12; }
        document.getElementById('clock').textContent = String(h).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+ampm;
        const days = ["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."];
        const months = ["janv.","f√©vr.","mars","avr.","mai","juin","juil.","ao√ªt","sept.","oct.","nov.","d√©c."];
        document.getElementById('dateLine').textContent = days[d.getDay()]+" "+d.getDate()+" "+months[d.getMonth()]+" "+d.getFullYear();
      }
      // Override ticking
      clearInterval(); // noop safeguard
      updateClock = updateClock12; // override reference
      updateClock(); setInterval(updateClock,60*1000);
    })();

    // ---------------- Audio ----------------
    const audioInput = document.getElementById('audioFile');
    const audio = document.getElementById('player');
    const audioName = document.getElementById('audioName');
    document.getElementById('playBtn').onclick = ()=>{ if(audio.src) audio.paused ? audio.play() : audio.pause(); };
    audioInput.onchange = ()=>{
      const f = audioInput.files && audioInput.files[0];
      if(!f) return;
      audio.src = URL.createObjectURL(f);
      audioName.textContent = f.name + " ("+Math.round(f.size/1024)+" Ko)";
      audio.play().catch(()=>{});
    };

    // ---------------- Weather (Open‚ÄëMeteo) ----------------
    const cityInput = document.getElementById('cityInput');
    const searchBtn = document.getElementById('citySearchBtn');
    const geoBtn = document.getElementById('geoBtn');
    const cityBadge = document.getElementById('cityBadge');
    const coordsBadge = document.getElementById('coordsBadge');
    const tzBadge = document.getElementById('tzBadge');
    const tempNow = document.getElementById('tempNow');
    const windNow = document.getElementById('windNow');
    const wdesc = document.getElementById('wdesc');
    const meteoDebug = document.getElementById('meteoDebug');

    const WMAP = {
      0:"Ciel clair", 1:"Principalement clair", 2:"Partiellement nuageux", 3:"Couvert",
      45:"Brouillard", 48:"Brouillard givrant",
      51:"Bruine l√©g√®re", 53:"Bruine", 55:"Bruine dense",
      56:"Bruine vergla√ßante l√©g√®re", 57:"Bruine vergla√ßante dense",
      61:"Pluie faible", 63:"Pluie", 65:"Pluie forte",
      66:"Pluie vergla√ßante faible", 67:"Pluie vergla√ßante",
      71:"Neige faible", 73:"Neige", 75:"Neige forte",
      77:"Grains de neige",
      80:"Averses faibles",81:"Averses",82:"Averses fortes",
      85:"Averses de neige faibles",86:"Averses de neige fortes",
      95:"Orage", 96:"Orage avec gr√©sil", 99:"Orage violent"
    };

    async function geocodeCity(q){
      const url = "https://geocoding-api.open-meteo.com/v1/search?count=1&language=fr&format=json&name="+encodeURIComponent(q);
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok) throw new Error("Geocoding HTTP "+r.status);
      const j = await r.json();
      if(!j.results || !j.results.length) throw new Error("Ville introuvable");
      const c = j.results[0];
      return { name: c.name + (c.admin1? ", "+c.admin1:"") + (c.country? " ‚Äî "+c.country:""), lat:c.latitude, lon:c.longitude, tz:c.timezone };
    }

    async function fetchWeather(lat, lon){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&timezone=auto`;
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok) throw new Error("Weather HTTP "+r.status);
      const j = await r.json();
      return j;
    }

    function setMeteoUI(city, lat, lon, tz, data){
      cityBadge.textContent = "Ville¬†: "+city;
      coordsBadge.textContent = "Coords¬†: "+lat.toFixed(3)+", "+lon.toFixed(3);
      tzBadge.textContent = "TZ¬†: "+tz;
      const c = data.current;
      tempNow.textContent = Math.round(c.temperature_2m)+"¬∞";
      windNow.textContent = Math.round(c.wind_speed_10m)+" km/h";
      const desc = WMAP[c.weather_code] || ("Code "+c.weather_code);
      wdesc.innerHTML = `<span class="badge">${desc}</span>`;
      meteoDebug.textContent = "";
    }

    async function loadCity(q){
      try{
        cityBadge.textContent = "Ville¬†: ‚Ä¶"; coordsBadge.textContent="Coords¬†: ‚Ä¶"; tzBadge.textContent="TZ¬†: ‚Ä¶";
        tempNow.textContent="‚Äî¬∞"; windNow.textContent="‚Äî km/h"; wdesc.textContent="‚Äî";
        const c = await geocodeCity(q);
        const w = await fetchWeather(c.lat, c.lon);
        setMeteoUI(c.name, c.lat, c.lon, c.tz, w);
        localStorage.setItem("aurion_city", JSON.stringify(c));
      }catch(err){
        meteoDebug.textContent = "Erreur¬†: "+err.message;
      }
    }
    searchBtn.onclick = ()=>{ const v = cityInput.value.trim(); if(v) loadCity(v) };

    geoBtn.onclick = ()=>{
      if(!navigator.geolocation){ meteoDebug.textContent = "G√©olocalisation non support√©e."; return; }
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        try{
          const {latitude:lat, longitude:lon} = pos.coords;
          const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=fr`;
          const r = await fetch(url,{cache:"no-store"}); const j = await r.json();
          const name = (j && j.results && j.results[0] && (j.results[0].name+(j.results[0].admin1? ", "+j.results[0].admin1:""))) || "Position actuelle";
          const tz = (j && j.results && j.results[0] && j.results[0].timezone) || Intl.DateTimeFormat().resolvedOptions().timeZone;
          const w = await fetchWeather(lat, lon);
          setMeteoUI(name, lat, lon, tz, w);
          localStorage.setItem("aurion_city", JSON.stringify({name, lat, lon, tz}));
        }catch(e){ meteoDebug.textContent = "Erreur¬†: "+e.message; }
      }, (err)=>{
        meteoDebug.textContent = "G√©olocalisation refus√©e¬†: "+err.message;
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    };

    // Charger la derni√®re ville si dispo
    (function(){
      try{
        const c = JSON.parse(localStorage.getItem("aurion_city")||"null");
        if(c){ fetchWeather(c.lat, c.lon).then(w=> setMeteoUI(c.name, c.lat, c.lon, c.tz, w)).catch(()=>{}); }
      }catch(_){}
    })();

    // ---------------- Aurion Console (real POST) ----------------
    function setHealth(text, ok){
      const el = document.getElementById('aurionHealth');
      if(!el) return; el.textContent = text; el.style.borderColor = ok? '#1f6b3a':'#6b1f1f'; el.style.color = ok? '#9affb0':'#ff9a9a';
    }
    const aurionUrl = document.getElementById('aurionUrl');
    const aurionKey = document.getElementById('aurionKey');
    const aurionSave = document.getElementById('aurionSave');
    const aurionPrompt = document.getElementById('aurionPrompt');
    const aurionSend = document.getElementById('aurionSend');
    const aurionOut = document.getElementById('aurionOut');
    const LS_AURION = "aurion_console_cfg";

    function loadAurionCfg(){
      try{
        const j = JSON.parse(localStorage.getItem(LS_AURION)||"{}");
        aurionUrl.value = j.url || "";
        aurionKey.value = j.key || "";
      }catch(_){}
    }
    function saveAurionCfg(){
      localStorage.setItem(LS_AURION, JSON.stringify({url: aurionUrl.value.trim(), key: aurionKey.value}));
      flashBtn(aurionSave);
    }
    aurionSave.onclick = saveAurionCfg;
    loadAurionCfg();
    // Diagnostic function and Help link
    async function diagnoseEndpoint(url){
      if(!url){ setHealth('Sant√©¬†: URL manquante', false); return 'D√©finis une URL'; }
      try{
        const t0 = performance.now();
        const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt:'ping' })});
        const ms = Math.round(performance.now()-t0);
        if(r.ok){ setHealth('Sant√©¬†: OK ('+ms+' ms)', true); return 'OK '+r.status; }
        if(r.status===404){ setHealth('Sant√©¬†: 404 (chemin faux)', false); return '404: v√©rifie le path (/aurion?)'; }
        if(r.status===401||r.status===403){ setHealth('Sant√©¬†: auth requise', false); return r.status+': token manquant/incorrect'; }
        if(r.status===405){ setHealth('Sant√©¬†: 405 (m√©thode)', false); return '405: m√©thode POST non accept√©e'; }
        if(r.status>=500){ setHealth('Sant√©¬†: serveur en erreur', false); return r.status+': upstream down'; }
        setHealth('Sant√©¬†: '+r.status, false); return 'HTTP '+r.status;
      }catch(e){
        setHealth('Sant√©¬†: √©chec r√©seau/CORS', false);
        return '√âchec fetch (CORS, DNS, tunnel ngrok expir√©, ou serveur off)';
      }
    }
    const aurionHelp = document.getElementById('aurionHelp');
    if(aurionHelp){
      aurionHelp.onclick = (ev)=>{
        ev.preventDefault();
        alert('D√©pannage rapide:\n‚Ä¢ 404 ‚Üí Mauvais chemin (/aurion?).\n‚Ä¢ 401/403 ‚Üí Ajoute le Bearer token.\n‚Ä¢ 405 ‚Üí Endpoint n\'accepte pas POST.\n‚Ä¢ 5xx ‚Üí Serveur en erreur (Render/VPS).\n‚Ä¢ √âchec r√©seau ‚Üí CORS bloqu√©, tunnel expir√©, DNS ou serveur √©teint.');
      };
    }
    // Test endpoint button
    const aurionTest = document.getElementById('aurionTest');
    if(aurionTest){
      aurionTest.onclick = async ()=>{
        const url = aurionUrl.value.trim();
        if(!url){ aurionOut.textContent = 'D√©finis un endpoint avant test.'; setHealth('Sant√©¬†: URL manquante', false); return; }
        aurionOut.textContent = 'Test‚Ä¶';
        try{
          const t0 = performance.now();
          const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt:'ping' })});
          const txt = await r.text();
          const ms = Math.round(performance.now()-t0);
          aurionOut.textContent = `[${ms} ms]\n` + txt;
        }catch(e){ aurionOut.textContent = 'Test √©chou√©: '+e.message; }
        const diag = await diagnoseEndpoint(url);
        aurionOut.textContent += `\n\n‚Üí Diagnostic: ${diag}`;
      };
    }

    async function callAurion(prompt){
      const url = aurionUrl.value.trim();
      if(!url){ aurionOut.textContent = "Erreur¬†: d√©finis un endpoint Aurion avant d‚Äôenvoyer."; return; }
      aurionOut.textContent = "Envoi‚Ä¶";
      try{
        const body = { prompt };
        const headers = { "Content-Type":"application/json" };
        if(aurionKey.value.trim()) headers["Authorization"] = "Bearer "+aurionKey.value.trim();
        const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
        const txt = await r.text();
        // Affiche tel quel (permet de voir JSON, texte, etc.)
        aurionOut.textContent = txt;
      }catch(err){
        aurionOut.textContent = "Erreur requ√™te¬†: "+err.message;
      }
    }
    aurionSend.onclick = ()=>{
      const p = aurionPrompt.value.trim();
      if(!p) return;
      callAurion(p);
    };
    aurionPrompt.addEventListener('keydown', e=>{ if(e.key==='Enter') aurionSend.click() });
  </script>
</body>
  <!-- Settings modal & Config tools -->
  <div id="settingsModal" style="position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:9999">
    <div style="width:min(520px,92%);background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #142033;border-radius:14px;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h2 style="margin:0;color:#a8c4de;letter-spacing:.8px;text-transform:uppercase;font-size:14px">R√©glages</h2>
        <button class="btn" id="settingsClose">Fermer</button>
      </div>
      <label class="row small"><input type="checkbox" id="optCompact"> Mode compact (mobile)</label>
      <label class="row small"><input type="checkbox" id="optReduceMotion"> R√©duire les animations</label>
      <label class="row small"><input type="checkbox" id="optClock12h"> Horloge 12h (am/pm)</label>
      <div class="row small" style="margin-top:10px">
        <button class="btn" id="cfgExport">Exporter config</button>
        <label class="btn" for="cfgImportInput">Importer config</label>
        <input type="file" id="cfgImportInput" accept="application/json" style="display:none">
      </div>
    </div>
  </div>
</html>